#!/bin/bash

# Kubernetes Tools - Copyright (C) 2017 Shawn Wang
# https://github.com/shawnxlw/kubernetes-tools
#
# You may use, distribute or modify this software under the terms of the MIT license.

source __common

current_context() {
  if [[ -z "${KCTX}" ]]
  then
    kubectl config current-context
  else
    echo "${KCTX}"
  fi
}

list_namespaces() {
  local my_context
  local my_namespace
  local highlight
  my_context=$(current_context)
  my_namespace=$(current_namespace)
  echo "Current Namespace: ${my_namespace}"
  echo "Current Context: ${my_context}"
  echo
  echo "All namespaces:"
  highlight=$(printf "\033[32m${my_namespace}\033[0m")
  kubectl get ns --context=${my_context} | sed "s/${my_namespace}\\([[:space:]]\\)/${highlight}\\1/g"
  exit
}

# prompt ns select
select_ns() {
  local my_context
  my_context=$(current_context)
  echo -e "Setting default namespace:\n"
  PS3="Please select a namespace:"
  OLD_IFS="$IFS"
  IFS=$'\n'
  NAMESPACES=($(kubectl get ns --context=${my_context} |awk '{print $1}'|sed '1d'))
  IFS="$OLD_IFS"

  select namespace in "${NAMESPACES[@]}"
  do
    update_context $namespace
    break
  done
}

# update context
update_context() {
    local my_context
    echo -e "\nSetting $1 as default namespace in current context...\n"
    my_context=$(current_context)
    kubectl config set-context ${my_context} --namespace=$1
    exit
}

# sohw help
show_help() {
  echo -e $__title
  echo
  echo -e "- List current and all namespaces: ${__style_underlined}kns${__style_end}"
  echo -e "- Select a default namespace: ${__style_underlined}kns [-s|--select]${__style_end}"
  echo -e "- Specify a default namespace: ${__style_underlined}kns [namespace]${__style_end}\n"
}

# parse arguments
while [ "$1" != "" ]; do
  case $1 in
    -n | --namespace ) shift
      update_context $1
      ;;
    -s | --select ) shift
      select_ns
      ;;
    -h | --help ) shift
      show_help
      exit 0
      ;;
    * ) update_context $1
  esac
  shift
done

# list namespaces if no arguments
if [ $# -eq 0 ]; then list_namespaces; fi
